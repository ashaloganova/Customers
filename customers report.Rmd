---
title: 'Анализ связи между демографическими и экономическими показателями и тратами покупателей на определенные категории товаров'
author: "Логанова Наталья"
output: 
  html_document:
    code_folding: hide
---

## Задача

Проверить взаимосвязи между разными переменными с помощью стат тестов в данных про покупки клиентов и построить дерево решений, кто примет предложение маркетинговой кампании, чтобы это помогло при расширении этой акции на другие магазины.

### Загрузка данных и преобразование

```{r message = FALSE, warning=FALSE}
marketing = read.csv("~/shared/minor2_2022/1-Intro/hw2/marketing_campaign.csv")
```

Я поменяла названия некоторых столбцов и создала колонку "age", вместо "Year_Birth". А также изменила формат данных "Dt_Customer" на дату.

```{r message = FALSE, warning=FALSE}
# библиотеки
library(dplyr)
library(compareGroups)
library(rpart)
library(rpart.plot)
library(readr)
library(ggplot2)
library(lubridate)

# преобразование данных, предобработка
marketing$Dt_Customer = dmy(marketing$Dt_Customer)
marketing = marketing %>% 
  rename(wines = MntWines, fruits = MntFruits, meat = MntMeatProducts, fish = MntFishProducts, sweet = MntSweetProducts, discount = NumDealsPurchases, web = NumWebPurchases, store = NumStorePurchases)
marketing = marketing %>% 
  mutate_if(is.character, as.factor)
marketing$Response = factor(marketing$Response)
marketing$AcceptedCmp = factor(marketing$AcceptedCmp)
marketing$Complain = factor(marketing$Complain)

# создадим колонку с возрастом и удалим пременную "год рождения"
marketing = marketing %>% mutate (Age = 2022 - Year_Birth)
marketing = marketing %>% select(-Year_Birth)

# поменяем дату, когда респондент стал клиентом компании "Dt_Customer", на количество дней прошедших с того момента.
marketing = marketing %>% 
  mutate (Day = today () - Dt_Customer) %>% 
  select (-Dt_Customer)
```

### Исследовательские вопросы и тесты

**1) В данных есть информация, откликнулся ли клиент на предыдущую кампанию. Правда ли, что пользователи, откликнувшиеся на предыдущую кампанию, чаще откликаются и дальше?**

Сформулируем гипотезы:

h0: доля  людей в том, кто откликнулся на текущую кампанию, не отличается между группой тех, кто принял предложение в предыдущей кампании, и тех, кто не принял в прошлый раз.

h1: доля  людей в том, кто откликнулся на текущую кампанию, различаются между группой тех, кто принял предложение в предыдущей кампании, и тех, кто не принял в прошлый раз.

Это две категориальные переменные, поэтому проведем тест Хи-квадрат.

```{r message = FALSE, warning=FALSE}
chisq.test(marketing$AcceptedCmp, marketing$Response)

count (marketing, AcceptedCmp, Response)
```
p-value получился меньше 0.05.

Содержательный вывод: **доля тех, кто окликнулся в предыдущей кампании, статистически отличается от доли тех, кто не отликнулся в прошлый раз**. То есть нулевая гипотеза отвергается и принимается альтернативная h1. Причем, **среди тех, кто откликнулся в предыдущей кампании, доля тех, кто сейчас откликнулся, равна 0.72. А среди тех, кто в прошлый раз не откликнулся, только 20% откликнулись в нынешней кампании.**

<br>

**2) Связана ли готовность откликнуться на кампанию с тем, где клиенты предпочитают делать покупки?**

h0: В том, кто отликнулся на текущую компанию, доля тех, кто предпочитает делать покупки в магазине, не отличается от доли тех, кто делает заказы преимущественно на сайте.

h1: В том, кто отликнулся на текущую компанию, доля тех, кто предпочитает делать покупки в магазине, различается от доли тех, кто делает заказы преимущественно на сайте.

Создадим новую колонку "where", которая показывает, где клиенты предпочитают совершать покупки.

```{r message = FALSE, warning=FALSE}
marketing = marketing %>% 
  mutate (where = factor (case_when(web > store ~ "web", store > web ~ "store", T ~ "no preferences")))
```

Переменные: where и response. Это две категориальные переменные, поэтому будем проводить тест Хи-квадрат.

```{r message = FALSE, warning=FALSE}
chisq.test(marketing$where, marketing$Response)

h2 = count (marketing, where, Response)
h2
```
p-value получился меньше 0.05. Я не буду учитывать людей, которые одинаково часто совершают покупки на сайте и в магазине. Сраниваю только тех, кто преимущественно в магазине покупает, и тех, кто больше всего на сайте. 

```{r}
h2 = h2 [-c(1,2), ]
h2$Response = as.factor(h2$Response)
h2$Response = factor (case_when(h2$Response == "0" ~ "Отказано", T ~ "Принято"))
h2$where = factor (case_when(h2$where == "store" ~ "Магазин", T ~ "Сайт"))
h2 = h2 %>% 
  rename (Отклик = Response)
  

ggplot() +
  geom_bar(data = h2, aes(x = where, y = n, fill = Отклик), stat = "identity", position = "fill") +
  theme_light() +
  scale_fill_manual(values=c("#8491B3", "#3D4C77")) +
  xlab("Где была совершена покупка?") +
  ylab("Соотношение") +
  ggtitle("Взаимосвязь отказа или принятия в маркетинговой кампании \nв зависимости от того, где была совершена покупка")
```

Содержательный вывод: **в том, кто принял предложение в текущей кампании, доля тех, кто предпочитает делать покупки в магазине, статистически отличается от доли тех, кто делает заказы преимущественно на сайте**. То есть нулевая гипотеза отвергается и принимается альтернативная h1. Причем, **среди тех, предпочитает заказывать на сайте, 40% людей приняли предложение в текущей компании. А среди тех, кто покупает в магазине, только 21% откликнулись в нынешней кампании.**

<br>

**3) Связаны ли покупки по скидке с тем, что человек примет предложение в маркетинговой кампании?**

Я предполагаю, что среднее количество покупок, совершенных по скидке больше у тех, кто принял предложение в маркетинговой кампании. Чтобы проверить это, сформулируем гипотезы.

h0: среднее количество покупок, совершенных по скидке, не отличается у тех, кто принял предложение, и у тех, кто отказал.

h0: среднее количество покупок, совершенных по скидке, различается у тех, кто принял предложение, и у тех, кто отказал.

Чтобы проверить это, проведем т-тест Стьюдента. 

```{r}
t.test(discount ~ Response, data = marketing)
```
P-value > 0.05.

Содержательный вывод: **среднее количество покупок, совершенных по скидке, статистически не различается у тех, кто участвовал в маркетинговой кампании и не участвовал**. То есть мы не можем отвергнуть нулевую гипотезу. Получается, **те, кто откликнулись в кампании и не откликнулись, купили по скидке одинаковое количество раз.**

### Предсказание отклика на кампанию

Построение дерева
```{r}
set.seed(1234)
marketing_train = marketing %>% sample_frac(.8)
marketing_test = anti_join(marketing, marketing_train, by = 'ID') 
marketing_train = marketing_train %>% select(-ID)

set.seed(1234)
tree <- rpart(Response ~ ., data = marketing_train, control=rpart.control(cp=0.0001), method = "class")
prp(tree, extra = 1)

pred = predict(tree, type = "class", data = marketing_train)

t = table(pred, marketing_train$Response)
t
(t[1,1] + t[2,2])/sum(t)

pred_test = predict(tree, newdata = marketing_test, type = "class")

t2 = table(pred_test, marketing_test$Response)
t2
(t2[1,1] + t2[2,2])/sum(t2)

cp_tbl = printcp(tree)
res = cp_tbl %>%
  as.data.frame() %>% 
  arrange(xerror) %>% 
  head(n = 1)
res

cppp = res$CP

tree2 = prune(tree, cp = cppp)
prp(tree2)

pred_prune = predict(tree2, type="class")
t3 = table(pred_prune, marketing_train$Response)
t3
(t3[1,1] + t3[2,2])/sum(t3)

pred_prune_test = predict(tree2, marketing_test, type = "class")
t4 = table(pred_prune_test, marketing_test$Response)
t4
(t4[1,1] + t4[2,2])/sum(t4)
```

Вывод: Это дерево предсказывает, примет ли предложение человек в маркетинговой кампании, основываясь на разных данных о клиентах. Точность по тренировочному датасету = 86%, по тестовой = 75%. Разница немаленькая, но это можно объяснить тем, что взяла СР при минимальном xerror. Дерево работает хорошо, потому что точносить выше 50%.


## Общие выводы

Проводив разведывательный анализ и проверив несколько гипотез, я пришла к таким выводам, которые могут пригодиться владельцам магазина при запуске следующих маркетинговых кампаний:

1. Доля  людей в том, кто откликнулся на текущую кампанию, различаются между группой тех, кто принял предложение в предыдущей кампании, и тех, кто не принял в прошлый раз. Среди тех, кто откликнулся в предыдущей кампании, доля тех, кто сейчас откликнулся, равна 0.72. А среди тех, кто в прошлый раз не откликнулся, только 20% откликнулись в нынешней кампании. Это значит, что нужно ориентироваться на людей, которые уже откликались в предыдущих кампаниях, так как они более лояльные.

2. В том, кто отликнулся на текущую компанию, доля тех, кто предпочитает делать покупки в магазине, различается от доли тех, кто делает заказы преимущественно на сайте. Среди тех, предпочитает заказывать на сайте, 40% людей приняли предложение в текущей компании. А среди тех, кто покупает в магазине, только 21% откликнулись в нынешней кампании. Получается, владельцам магазина нужно рекламировать больше тем, кто заказывает на сайте. Думаю, это будет даже легче, так как проще показать рекламу.

3. Среднее количество покупок, совершенных по скидке, не отличается у тех, кто принял предложение, и у тех, кто отказал. Это значит, что не нужно делить своих людей, кто пользуется скидкой или нет, так как обе группы примерно одинаковые.